<space>
  <!-- Luz y ambiente -->
  <light type="ambient" intensity="2.2" />
  <light type="directional" intensity="1.0" color="#ffffff" x="5" y="10" z="5" />

  <!-- Mundo base -->
  <group id="world">
    <!-- Pista (3 carriles) -->
    <plane id="ground" width="14" height="160" color="#222222" y="0" z="-40" />
    <!-- Líneas de carril decorativas -->
    <box width="0.05" height="0.02" depth="160" x="-4" y="0.01" z="-40" color="#2f2f2f" />
    <box width="0.05" height="0.02" depth="160" x="0"  y="0.01" z="-40" color="#2f2f2f" />
    <box width="0.05" height="0.02" depth="160" x="4"  y="0.01" z="-40" color="#2f2f2f" />

    <!-- Barreras laterales -->
    <box width="0.4" height="1" depth="160" x="-7.2" y="0.5" z="-40" color="#303a3a" />
    <box width="0.4" height="1" depth="160" x="7.2"  y="0.5" z="-40" color="#303a3a" />

    <!-- Arcos decorativos -->
    <box width="14" height="0.2" depth="0.4" x="0" y="2.4" z="-10" color="#353535" class="bob" />
    <box width="14" height="0.2" depth="0.4" x="0" y="2.4" z="-30" color="#353535" class="bob" />
    <box width="14" height="0.2" depth="0.4" x="0" y="2.4" z="-50" color="#353535" class="bob" />

    <!-- Puerta y botón interactuable (se abre por contacto del jugador) -->
    <box id="gate1" width="12" height="1.5" depth="1.2" x="0" y="0.75" z="-35" color="#546e7a" />
    <box id="button1" width="1" height="0.2" depth="1" x="0" y="0.1" z="-25" color="#43a047" class="interactable" />

    <!-- Decor orbes giratorios -->
    <sphere radius="0.35" x="-6" y="1.3" z="-12" color="#90caf9" class="spin" />
    <sphere radius="0.35" x="6"  y="1.3" z="-28" color="#90caf9" class="spin" />
    <sphere radius="0.35" x="-6" y="1.3" z="-44" color="#90caf9" class="spin" />
  </group>

  <!-- Jugador -->
  <group id="playerRoot">
    <box id="player" width="1" height="1" depth="1" color="#ffca28" x="0" y="0.5" z="5" />
  </group>

  <!-- Script del juego: runner de 3 carriles con obstáculos, monedas y puerta -->
  <script>
    // ==== Configuración inicial ====
    const lanes = [-4, 0, 4];
    let laneIndex = 1;

    const player = dimension.find('#player')[0];
    player.setAttribute('x', lanes[laneIndex]);
    player.setAttribute('y', 0.5);
    player.setAttribute('z', 5);
    player.setAttribute('width', 1);
    player.setAttribute('height', 1);
    player.setAttribute('depth', 1);

    const world = dimension.find('#world')[0];
    const gate = dimension.find('#gate1')[0];
    const button = dimension.find('#button1')[0];

    // Física simple de salto
    let vy = 0;
    const GRAV = -18;
    const JUMP = 8;

    // Estado de juego
    let speed = 10;      // velocidad de avance del mundo
    let score = 0;
    let health = 3;
    let timeSinceSpeedUp = 0;
    let gateOpen = false;

    // Input (teclado)
    window.addEventListener('keydown', (e) => {
      if (e.code === 'KeyA' || e.code === 'ArrowLeft')  laneIndex = Math.max(0, laneIndex - 1);
      if (e.code === 'KeyD' || e.code === 'ArrowRight') laneIndex = Math.min(lanes.length - 1, laneIndex + 1);
      if ((e.code === 'Space' || e.code === 'KeyW' || e.code === 'ArrowUp') && Math.abs((parseFloat(player.attributes.y||0.5)) - 0.5) < 0.001) {
        vy = JUMP;
      }
    });

    // Colecciones dinámicas
    const obstacles = [];
    const coins = [];

    // ==== Generadores ====
    function spawnObstacle() {
      const lane = lanes[Math.floor(Math.random()*lanes.length)];
      const h = 1 + Math.random()*1.8;
      const w = 1 + Math.random()*1.2;
      const color = '#e57373';
      const o = dimension.create('box', { class: 'obstacle', width: w, height: h, depth: 1, color, x: lane, y: h/2, z: -60 });
      dimension.appendChild(o);
      obstacles.push(o);
    }

    function spawnCoinRow() {
      const lane = lanes[Math.floor(Math.random()*lanes.length)];
      for (let i=0;i<5;i++) {
        const c = dimension.create('sphere', { class: 'coin spin', radius: 0.3, color: '#ffd54f', x: lane, y: 1.2 + (i%2)*0.25, z: -60 - i*2 });
        dimension.appendChild(c);
        coins.push(c);
      }
    }

    // Población inicial
    for (let i=0;i<8;i++)  spawnObstacle();
    for (let i=0;i<4;i++)  spawnCoinRow();

    // Título
    function updateTitle() {
      document.title = 'Runner HSML — Vidas: ' + health + ' | Puntos: ' + score;
    }
    updateTitle();

    // ==== Utilidades de colisión ====
    function num(v, d=0) { v = parseFloat(v); return isFinite(v) ? v : d; }

    function intersectsAABB(a,b) {
      const ax = num(a.attributes.x), ay = num(a.attributes.y), az = num(a.attributes.z);
      const aw = num(a.attributes.width, 1), ah = num(a.attributes.height, 1), ad = num(a.attributes.depth, 1);
      const bx = num(b.attributes.x), by = num(b.attributes.y), bz = num(b.attributes.z);
      const bw = num(b.attributes.width, 1), bh = num(b.attributes.height, 1), bd = num(b.attributes.depth, 1);
      return Math.abs(ax - bx) <= (aw/2 + bw/2) &&
             Math.abs(ay - by) <= (ah/2 + bh/2) &&
             Math.abs(az - bz) <= (ad/2 + bd/2);
    }

    function intersectsSphere(a, s) {
      // AABB vs Sphere
      const ax = num(a.attributes.x), ay = num(a.attributes.y), az = num(a.attributes.z);
      const aw = num(a.attributes.width, 1), ah = num(a.attributes.height, 1), ad = num(a.attributes.depth, 1);
      const sx = num(s.attributes.x), sy = num(s.attributes.y), sz = num(s.attributes.z);
      const r = num(s.attributes.radius, 0.5);
      const dx = Math.max(Math.abs(sx-ax) - aw/2, 0);
      const dy = Math.max(Math.abs(sy-ay) - ah/2, 0);
      const dz = Math.max(Math.abs(sz-az) - ad/2, 0);
      return dx*dx + dy*dy + dz*dz <= r*r;
    }

    // ==== Lógica por frame ====
    setUpdate((dt) => {
      // Movimiento suave al carril objetivo
      const targetX = lanes[laneIndex];
      const px = num(player.attributes.x);
      player.attributes.x = px + (targetX - px) * Math.min(1, dt*10);

      // Salto/gravedad
      let py = num(player.attributes.y, 0.5);
      vy += GRAV * dt;
      py += vy * dt;
      if (py < 0.5) { py = 0.5; vy = 0; }
      player.attributes.y = py;

      // Avance del mundo
      const v = speed;
      for (let i = obstacles.length-1; i >= 0; i--) {
        const o = obstacles[i];
        o.attributes.z = num(o.attributes.z) + v*dt;
        if (o.attributes.z > 30) {
          obstacles.splice(i,1);
          dimension.remove(o);
          spawnObstacle();
          continue;
        }
        if (intersectsAABB(player, o)) {
          // golpe
          health -= 1;
          o.attributes.color = '#ff1744';
          o.attributes.z = num(o.attributes.z) + 1.5;
          if (health <= 0) { resetGame(); return; }
          updateTitle();
        }
      }

      for (let i = coins.length-1; i >= 0; i--) {
        const c = coins[i];
        c.attributes.z = num(c.attributes.z) + v*dt;
        if (num(c.attributes.z) > 30) {
          coins.splice(i,1);
          dimension.remove(c);
          if (Math.random() < 0.5) spawnCoinRow();
          continue;
        }
        if (intersectsSphere(player, c)) {
          score += 10;
          coins.splice(i,1);
          dimension.remove(c);
          updateTitle();
        }
      }

      // Interacción por "toque" con botón abre-puerta
      if (!gateOpen && intersectsAABB(player, button)) {
        gateOpen = true;
        // achatar puerta
        gate.attributes.height = 0.1;
        gate.attributes.y = 0.05;
        gate.attributes.color = '#78909c';
        button.attributes.color = '#a5d6a7';
        score += 25;
        updateTitle();
      }

      // Acelerar ligeramente con el tiempo
      timeSinceSpeedUp += dt;
      if (timeSinceSpeedUp > 5) {
        timeSinceSpeedUp = 0;
        speed = Math.min(22, speed + 0.5);
      }
    });

    function resetGame() {
      // Limpiar dinámicos
      obstacles.forEach(o => dimension.remove(o));
      coins.forEach(c => dimension.remove(c));
      obstacles.length = 0;
      coins.length = 0;

      // Reset jugador
      laneIndex = 1; vy = 0;
      player.attributes.x = lanes[1];
      player.attributes.y = 0.5;
      player.attributes.z = 5;

      // Reset puerta/botón
      gateOpen = false;
      gate.attributes.height = 1.5;
      gate.attributes.y = 0.75;
      gate.attributes.color = '#546e7a';
      button.attributes.color = '#43a047';

      // Reset progreso
      speed = 10; score = 0; health = 3; timeSinceSpeedUp = 0;

      // Re-poblar
      for (let i=0;i<8;i++)  spawnObstacle();
      for (let i=0;i<4;i++)  spawnCoinRow();

      updateTitle();
    }
  </script>
</space>
